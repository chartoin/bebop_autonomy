cmake_minimum_required(VERSION 2.8.3)
project(bebop_driver)

## Find catkin macros and libraries
## if COMPONENTS list like find_package(catkin REQUIRED COMPONENTS xyz)
## is used, also find other catkin packages
find_package(catkin REQUIRED COMPONENTS
  bebop_msgs
  nodelet
  camera_info_manager
  image_transport
  nav_msgs
  roscpp
  std_msgs
  tf
  dynamic_reconfigure
  roslint
)

generate_dynamic_reconfigure_options(
  cfg/autogenerated/bebop_ardrone3.cfg
)

# Video decoding dependencies (libbebop)
find_package(PkgConfig REQUIRED)
pkg_check_modules(AVCODEC REQUIRED libavcodec)
pkg_check_modules(AVFORMAT REQUIRED libavformat)
pkg_check_modules(SWSCALE REQUIRED libswscale)

# TODO: Should we state all catkin depends?
catkin_package(
   INCLUDE_DIRS include
   LIBRARIES libbebop bebop_driver_nodelet
   CATKIN_DEPENDS bebop_msgs roscpp nodelet camera_info_manager image_transport nav_msgs std_msgs tf dynamic_reconfigure
   DEPENDS system_lib libavcodec libavformat libswscale
)

# roslint
set(ROSLINT_CPP_OPTS "--filter=-build/include")
roslint_cpp(
  src/bebop.cpp
  src/bebop_driver_node.cpp
  src/bebop_driver_nodelet.cpp
  src/bebop_video_decoder.cpp
  include/bebop_driver/bebop.h
  include/bebop_driver/bebop_driver_nodelet.h
  include/bebop_driver/bebop_video_decoder.h
)

###########
## Build ##
###########

# Build ARDroneSDK3 through their custom build manager (arsdk_manifests)
# TODO: Replace ExternalProject with a catkin package wrapper or a cmake macro.
# http://developer.parrot.com/docs/bebop/#how-to-build-the-sdk
# The new build system (>= 3.8) uses Android `repo-git` tool
#include(ExternalProject)
#ExternalProject_Add(ARSDKBuildUtils
#    GIT_REPOSITORY https://github.com/Parrot-Developers/arsdk_manifests.git
#    GIT_TAG ARSDK3_version_3_8
#    PREFIX ${CATKIN_DEVEL_PREFIX}
#    UPDATE_COMMAND curl https://storage.googleapis.com/git-repo-downloads/repo > ./repo COMMAND chmod a+x ./repo COMMAND ./repo --color=never init -u ./
#    CONFIGURE_COMMAND ./repo sync
#    BUILD_COMMAND ./build.sh -p Unix-forall -t build-sdk -j
#    INSTALL_COMMAND echo "No install"
#    BUILD_IN_SOURCE 1
#)
#

#message(STATUS "Building ARDroneSDK3")
#include(cmake/BuildARSDK3.cmake)
#build_arsdk3("54e1827594068d5c2be55d836e8be6f532770c48" ARDRONESDK3_PATH)

add_custom_target(ARSDKBuildUtils
  WORKING_DIRECTORY ${CATKIN_DEVEL_PREFIX}
  COMMAND curl -s https://storage.googleapis.com/git-repo-downloads/repo > ./repo
  COMMAND chmod a+x ./repo
  COMMAND ./repo --color=never init -u https://github.com/Parrot-Developers/arsdk_manifests.git -b 54e1827594068d5c2be55d836e8be6f532770c48 -m release.xml
  COMMAND ./repo sync
  COMMAND ./build.sh -p Unix-forall -t build-sdk
)

set(ARDRONESDK3_PATH "${CATKIN_DEVEL_PREFIX}/out/Unix-base/staging/usr")

include_directories(
  ${catkin_INCLUDE_DIRS}
  include
  ${ARDRONESDK3_PATH}/include
  ${AVCODEC_INCLUDE_DIRS}
  ${AVFORMAT_INCLUDE_DIRS}
  ${SWSCALE_INCLUDE_DIRS}
)
link_directories(${ARDRONESDK3_PATH}/lib)

add_library(libbebop src/bebop.cpp src/bebop_video_decoder.cpp)
target_link_libraries(libbebop
  ${catkin_LIBRARIES}
  arsal
  arcontroller
  ardiscovery
  ${AVCODEC_LIBRARIES}
  ${AVFORMAT_LIBRARIES}
  ${SWSCALE_LIBRARIES}
)
add_dependencies(libbebop ARSDKBuildUtils)

add_library(bebop_driver_nodelet src/bebop_driver_nodelet.cpp)
target_link_libraries(bebop_driver_nodelet
  ${catkin_LIBRARIES}
  libbebop
)
add_dependencies(bebop_driver_nodelet ${PROJECT_NAME}_gencfg)

add_executable(bebop_driver_node src/bebop_driver_node.cpp)
target_link_libraries(bebop_driver_node
  ${catkin_LIBRARIES}
  libbebop
)
add_dependencies(bebop_driver_node ${PROJECT_NAME}_gencfg)


#############
## Install ##
#############

# all install targets should use catkin DESTINATION variables
# See http://ros.org/doc/api/catkin/html/adv_user_guide/variables.html

## Mark executable scripts (Python etc.) for installation
## in contrast to setup.py, you can choose the destination
# install(PROGRAMS
#   scripts/my_python_script
#   DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION}
# )

## Mark executables and/or libraries for installation
# install(TARGETS bebop_autonomy bebop_autonomy_node
#   ARCHIVE DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
#   LIBRARY DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
#   RUNTIME DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION}
# )

## Mark cpp header files for installation
# install(DIRECTORY include/${PROJECT_NAME}/
#   DESTINATION ${CATKIN_PACKAGE_INCLUDE_DESTINATION}
#   FILES_MATCHING PATTERN "*.h"
#   PATTERN ".svn" EXCLUDE
# )

## Mark other files for installation (e.g. launch and bag files, etc.)
# install(FILES
#   # myfile1
#   # myfile2
#   DESTINATION ${CATKIN_PACKAGE_SHARE_DESTINATION}
# )

#############
## Testing ##
#############

if(CATKIN_ENABLE_TESTING)
  find_package(rostest REQUIRED)
  add_rostest_gtest(bebop_itl_test test/bebop_itl_test.test test/bebop_itl_test.cpp)
  target_link_libraries(bebop_itl_test ${catkin_LIBRARIES})
endif()
